import mysql.connector
from mysql.connector import errorcode

def run(target, port, username, password):
    try:
        #print(f"[+] Attempting to connect to {target}:{port} as {username or 'anonymous'}")

        conn = mysql.connector.connect(
            host=target,
            port=port,
            user=username if username else '',
            password=password if password else '',
            connection_timeout=5
        )

        #print("[+] Login successful!")

        cursor = conn.cursor()
        cursor.execute("SHOW DATABASES")
        databases = [db[0] for db in cursor.fetchall()]
        #print(f"[+] Databases found: {databases}")

        users = []
        try:
            cursor.execute("SELECT user, host FROM mysql.user")
            users = cursor.fetchall()
        except mysql.connector.Error:
            pass
            #print("[-] No permission to read mysql.user")

        conn.close()

        return {
            "success": True,
            "databases": databases,
            "users": users,
            "error": None
        }

    except mysql.connector.Error as err:
        return {
            "success": False,
            "databases": [],
            "users": [],
            "error": str(err)
        }
